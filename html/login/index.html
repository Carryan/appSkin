<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>首页</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" type="text/css" href="../../fonts/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../../fonts/iconfont2.css" />
		<link rel="stylesheet" type="text/css" href="../../fonts/system/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../../css/common.css" />
		<style>
			[v-cloak] {
				visibility: hidden;
			}
			.mui-bar-tab .mui-tab-item.mui-active {
				color: #00CFBD;
			}
			
		</style>
	</head>


	<body>
		<nav v-cloak class="mui-bar mui-bar-tab" id="indexPage">
			<template v-cloak v-for="(model,index) in showArray">
				<a v-cloak :id=model.tempID :class='index==0?"mui-tab-item mui-active":"mui-tab-item"' :href=model.href>
					<span v-cloak :class=model.cls></span>
					<span v-cloak class="mui-tab-label">{{model.name}}</span>
				</a>
			</template>
		</nav>
		<script src="../../js/utils/storageKeyName.js"></script>
		<script src="../../js/utils/mui.min.js"></script>
		<script src="../../js/utils/app-update.js"></script>
		<script src="../../js/utils/vconsole.min.js"></script>
		<script src="../../js/utils/vue.js"></script>
		<script src="../../js/utils/store.js"></script>
		<script src="../../js/utils/utils.js"></script>
		<script src="../../js/libs/jquery.js"></script>
		<script type="text/javascript" charset="utf-8">
			mui.init();
			var personal = store.get(window.storageKeyName.PERSONALINFO);
			var subpage_style = {
				top: '0px',
				bottom: '51px',
				statusbar:{
					background: "#00CFBD"
				}
			};

			window.addEventListener('home_refresh', function(data) {
				location.reload();
			});

			var indexPage = new Vue({
				el: "#indexPage",
				data: {
					showArray: [],
					pageArray: [{
						name: "kaoqin",
						href: "../../html/schapp_work/index.html",
						tempID: 'defaultTab',
						cls: 'mui-icon iconfont icon-xitongkaoqin',
						img_href: "../../img/kaoqin/kaoqin_tab.png",
						url: 'schapp_Work',
						childList: [
								{
									name:'请假记录',
									icon:'../../img/kaoqin/qingjiajilu.png',
									href: "../../html/schapp_work/qingjiaIndex.html",
									url:'schapp_Work_leave'
								},{
									name:'课堂考勤',
									icon:'../../img/kaoqin/ketangkaoqin.png',
									href: "../../html/schapp_work/ketangIndex.html",
									url:'schapp_Work_classroom'
								},{
									name:'课外考勤',
									icon:'../../img/kaoqin/kewaikaoqin.png',
									href: "../../html/schapp_work/kewaiIndex.html",
									url:'schapp_Work_extracurricular'
								},{
									name:'出入校报表',
									icon:'../../img/kaoqin/churuxiaokaoqin.png',
									href: "../../html/schapp_work/jinchuxiaoForm.html",
									url:'schapp_Work_inoutschool_form'
								},{
									name:'课堂报表',
									icon:'../../img/kaoqin/ketangbaobiao.png',
									href: "../../html/schapp_work/ketangForm.html",
									url:'schapp_Work_classroom_form'
								},{
									name:'课外报表',
									icon:'../../img/kaoqin/kewaibaobiao.png',
									href: "../../html/schapp_work/kewaiForm.html",
									url:'schapp_Work_extracurricular_form'
								},{
									name:'班级报表',
									icon:'../../img/kaoqin/banjibaobiao.png',
									href: "../../html/schapp_work/banjiForm.html",
									url:'schapp_Work_class_form'
								},{
									name:'学生报表',
									icon:'../../img/kaoqin/xueshengbaobiao.png',
									href: "../../html/schapp_work/xueshengForm.html",
									url:'schapp_Work_students_form'
								},
							]
					}, {
						name: "oa",
						href: "../../html/page2/index.html",
						img_href: "../../img/oa/oa_tab.png",
						tempID: 'kecheng',
						cls: 'mui-icon iconfont icon-OAxitong',
						url: 'schapp_OA',
						childList: [
								{
									name:'公告',
									NoReadCnt:0,
									icon:'../../img/oa/gonggao.png',
									href: "../../html/page2/gonggaoIndex.html",
									type : 1,
									url:'schapp_OA_Notify'
								},{
									name:'通知',
									NoReadCnt:0,
									icon:'../../img/oa/tongzhi.png',
									href: "../../html/page2/noticeIndex.html",
									url:'schapp_OA_Notice'
								},{
									name:'事务',
									NoReadCnt:0,
									icon:'../../img/oa/shiwu.png',
									href: "../../html/page2/shiwuIndex.html",
									url:'schapp_OA_CooperateNotice'
								},{
									name:'工作流',
									NoReadCnt:0,
									icon:'../../img/oa/gongzuoliu.png',
									href: "../../html/page2/workflowIndex.html",
									url:'schapp_OA_Approve'
								},{
									name:'资料收集',
									NoReadCnt:0,
									icon:'../../img/oa/ziliaoshouji.png',
									href: "../../html/page2/collectionDataIndex.html",
									url:'schapp_OA_DataCollection'
								},{
									name:'校历',
									NoReadCnt:0,
									icon:'../../img/oa/xiaoli.png',
									type : 3,
									href: "../../html/page2/gonggaoIndex.html",
									url:'schapp_OA_Xiaoli'
								},{
									name:'周程',
									NoReadCnt:0,
									type : 2,
									icon:'../../img/oa/zhoucheng.png',
									href: "../../html/page2/gonggaoIndex.html",
									url:'schapp_OA_Zhoucheng'
								},{
									name:'工资条',
									NoReadCnt:0,
									icon:'../../img/oa/gongzitiao.png',
									href: "../../html/page2/gongziIndex.html",
									url:'schapp_OA_Payment'
								},
							]
					}, {
						name: "page3",
						href: "../../html/page3/index.html",
						img_href: "../../img/xuesheng_xingwei/xingwei_tab.png",
						tempID: 'xueshengxingwei',
						cls: 'mui-icon iconfont icon-xueshenghangwei',
						url: 'schapp_Behavior',
						childList: []
					}, {
						name: "page4",
						href: "../../html/page4/index.html",
						img_href: "../../img/xuesheng_pingyu/pingyu_tab.png",
						tempID: 'xueshengpingyu',
						cls: 'mui-icon iconfont icon-xueshengpingyu',
						url: 'schapp_Comment',
						childList: []
					}, {
						name: "page5",
						href: "../../html/page5/index.html",
						img_href: "../../img/ziyuanguanli/ziyuanguanli_tab.png",
						tempID: 'ziyuanguanli',
						cls: 'mui-icon iconfont icon-ziyuanguanli',
						url: 'schapp_Resource',
						childList: []
					}, {
						name: "page6",
						href: "../../html/page6/index.html",
						img_href: "../../img/xuesheng_lianghuakaoping/lianghuakaoping_tab.png",
						tempID: 'xueshenglianghuakaoping',
						cls: 'mui-icon iconfont icon-xueshenglianghuakaoping',
						url: 'schapp_Evaluation',
						childList: []
					}
					, {
						name: "kaowu",
						href: "../../html/schapp_examination/index.html",
						img_href: "../../img/examination/kaowu_tab.png",
						tempID: 'kaowuxitong',
						cls: 'mui-icon iconfont icon-kaowuxitong',
						url: 'schapp_Examination',
						childList: []
					},
					{
						name: "wupinguanli",
						href: "../../html/schapp_item/index.html",
						img_href: "../../img/wupin/wupin_tab.png",
						tempID: 'wupinguanli',
						cls: 'mui-icon iconfont icon-wupinguanli',
						url: 'schapp_Item',
						childList: [
							{
								name:'物品入库',
								icon:'../../img/wupin/wupinruku.png',
								href: "../../html/schapp_item/item_in_index.html",
								url:'schapp_Item_warehouse'
							},{
								name:'物品出库',
								icon:'../../img/wupin/wupinchuku.png',
								href: "../../html/schapp_item/item_out_index.html",
								url:'schapp_Item_outbound'
							},{
								name:'库存查询',
								icon:'../../img/wupin/kucunchaxun.png',
								href: "../../html/schapp_item/item_select_index.html",
								url:'schapp_Item_stock'
							},
						]
					},
					{
						name: "kaoqin",
						href: "../../html/teachercAttendance/index.html",
						img_href: "../../img/wupin/wupin_tab.png",
						tempID: 'kaoqin',
						cls: 'mui-icon iconfont icon-wupinguanli',
						url: 'schapp_Attendance',
						childList: [
							{
								name:'我的考勤',
								icon:'../../img/wupin/wupinruku.png',
								href: "../../html/teachercAttendance/myAttendance.html",
								url:'schapp_Attendance_My'
							},{
								name:'考勤查询',
								icon:'../../img/wupin/wupinchuku.png',
								href: "../../html/teachercAttendance/attendanceSearch.html",
								url:'schapp_Attendance_Search'
							},{
								name:'考勤报表',
								icon:'../../img/wupin/wupinchuku.png',
								href: "../../html/teachercAttendance/attendanceForm.html",
								url:'schapp_Attendance_Form'
							},
						]
					},{
						name: "richeng",
						href: "../../html/programme/index.html",
						img_href: "../../img/wupin/wupin_tab.png",
						tempID: 'richeng',
						cls: 'mui-icon iconfont icon-wupinguanli',
						url: 'schapp_Programme',
						childList: [
							{
								name:'我的日程',
								icon:'../../img/wupin/wupinruku.png',
								href: "../../html/programme/myProgramme.html",
								url:'schapp_Programme_My'
							},{
								name:'部门日程',
								icon:'../../img/wupin/wupinchuku.png',
								href: "../../html/programme/dptProgramme.html",
								url:'schapp_Programme_Dpt'
							},
						]
					},
					]
				}
			});

			//创建子页面，首个选项卡页面显示，其它均隐藏；
			mui.plusReady(function() {
				
				console.log("personal: " + JSON.stringify(personal));
				appUpdate.updateApp(personal.unit_code);
				var tempMenu = store.get(window.storageKeyName.MENULIST);
				console.log('tempMenu:' + JSON.stringify(tempMenu));
				var tempA = [];
				for (var i = 0; i < tempMenu.list[0].childList.length; i++) {//一级菜单循环
					var web_first_item = tempMenu.list[0].childList[i];
					for (var a = 0; a < indexPage.pageArray.length; a++) {
						var local_first_item = indexPage.pageArray[a];
						if (local_first_item.url == web_first_item.url) {
							local_first_item.name = web_first_item.name;
							local_first_item.access=web_first_item.access;
							let childList=[]
							for (var b = 0; b < web_first_item.childList.length; b++) {//二级菜单循环
								var web_second_item = web_first_item.childList[b];
								for (var c = 0; c < local_first_item.childList.length; c++) {
									var local_second_item = local_first_item.childList[c];
									if (local_second_item.url == web_second_item.url) {
										local_second_item.access = web_second_item.access;
										local_second_item.redspot_url = web_second_item.redspot_url;
										local_second_item.name = web_second_item.name;
										childList.push(local_second_item)
									}
								}
							}
							local_first_item.childList=childList
							tempA.push(local_first_item);
						} 
					}
				}
				if (tempA.length > 5) {
					var tempArrayM = tempA.slice(4);
					store.set(window.storageKeyName.MOREMENU, tempArrayM);
					tempA = tempA.slice(0, 4);
					tempA.push({
						name: "更多",
						href: "../../html/more/index.html",
						tempID: 'kejiao4',
						cls: 'mui-icon iconfont icon-gengduo',
						url: 'more',
					});
				}
				indexPage.showArray = [].concat(tempA);

				//安卓的连续点击两次退出程序
				var backButtonPress = 0;
				//重写返回键
				mui.back = function(event) {
					backButtonPress++;
					if (backButtonPress > 1) {
						plus.runtime.quit();
					} else {
						plus.nativeUI.toast('再按一次退出应用');
					}
					setTimeout(function() {
						backButtonPress = 0;
					}, 1000);
					return false;
				};
				if (indexPage.showArray.length == 0) {
					mui.toast('暂无可用菜单');
					setTimeout(function() {
						store.remove(window.storageKeyName.PERSONALINFO);
						plus.webview.open('../../html/login/loginIndex.html','../../html/login/loginIndex.html',{statusbar:{background: "#00CFBD"}});
						var curr = plus.webview.currentWebview();
						var wvs = plus.webview.all();
						for (var i = 0, len = wvs.length; i < len; i++) {
							//关闭除login页面外的其他页面
							if (wvs[i].getURL().indexOf('loginIndex.html') != -1) {
								continue;
							}
							plus.webview.close(wvs[i]);
						}
						curr.close();
					}, 1000);
				}
				var defaultUrl = indexPage.showArray[0].href;
				var self = plus.webview.currentWebview();
				var tempM = indexPage.showArray[0];
				var sub = plus.webview.create(defaultUrl, defaultUrl, subpage_style, {
					preload: tempM
				});
				self.append(sub);
				//当前激活选项
				activeTab = defaultUrl;
				var title = document.getElementById("title");
				console.log('11111111');
				//选项卡点击事件
				mui('.mui-bar-tab').on('tap', 'a', function(e) {
					var targetTab = this.getAttribute('href');
					console.log('11111111222:' + targetTab);
					if (targetTab == activeTab) {
						return;
					} else {
						var viewIsExists = plus.webview.getWebviewById(targetTab);
						if (viewIsExists == null || viewIsExists == '' || viewIsExists == undefined) {
							for (var i = 0; i < indexPage.showArray.length; i++) {
								var tempM = indexPage.showArray[i];
								if (targetTab == tempM.href) {
									var pageIndex = plus.webview.getWebviewById(targetTab);
									var newSub = plus.webview.create(targetTab, targetTab, subpage_style, {
										preload: tempM
									});
									newSub.hide();
									self.append(newSub);
								}
							}

						}
					}
					//更换标题
					//title.innerHTML = this.querySelector('.mui-tab-label').innerHTML;
					plus.webview.show(targetTab, "fade-in", 00);
					//隐藏当前;
					plus.webview.hide(activeTab);
					//更改当前活跃的选项卡 
					activeTab = targetTab;
				});
				setTimeout(function() {
					var defaultTab = document.getElementById(indexPage.showArray[0].tempID);
					console.log('11111111defaultTab:' + defaultTab);
					//模拟首页点击
					mui.trigger(defaultTab, 'tap');
					//切换选项卡高亮
					var current = document.querySelector(".mui-bar-tab>.mui-tab-item.mui-active");
					if (defaultTab !== current) {
						current.classList.remove('mui-active');
						defaultTab.classList.add('mui-active');
					}
				}, 1000);

			});
		</script>
	</body>

</html>
