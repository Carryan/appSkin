<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>首页</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" type="text/css" href="../../fonts/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../../fonts/iconfont2.css" />
		<link rel="stylesheet" type="text/css" href="../../css/common.css" />
		<style>
			.mui-bar-tab .mui-tab-item.mui-active {
				color: #00CFBD;
			}
		</style>
	</head>

	<body>
		<nav v-cloak class="mui-bar mui-bar-tab" id="indexPage">
			<template v-for="(model,index) in showArray">
				<a :id=model.tempID :class='index==0?"mui-tab-item mui-active":"mui-tab-item"' :href=model.href>
					<span :class=model.cls></span>
					<span class="mui-tab-label">{{model.name}}</span>
				</a>
			</template>
		</nav>
		<script src="../../js/utils/storageKeyName.js"></script>
		<script src="../../js/utils/mui.min.js"></script>
		<script src="../../js/utils/vconsole.min.js"></script>
		<script src="../../js/utils/vue.js"></script>
		<script src="../../js/utils/store.js"></script>
		<script src="../../js/utils/utils.js"></script>
		<script src="../../js/libs/jquery.js"></script>
		<script type="text/javascript" charset="utf-8">
			mui.init();
			var personal = store.get(window.storageKeyName.PERSONALINFO);
			var subpage_style = {
				top: '0px',
				bottom: '51px'
			};

			window.addEventListener('home_refresh', function(data) {
				location.reload();
			});

			var indexPage = new Vue({
				el: "#indexPage",
				data: {
					showArray: [],
					pageArray: [{
						name: "page1",
						href: "../../html/page1/index.html",
						tempID: 'defaultTab',
						cls: 'mui-icon iconfont icon-jiaxiaohudong',
						permission: 'schapp_Work',
						childList: []
					}, {
						name: "page2",
						href: "../../html/page2/index.html",
						tempID: 'kecheng',
						cls: 'mui-icon iconfont icon-timu',
						permission: 'schapp_OA',
						childList: []
					}, {
						name: "page3",
						href: "../../html/page3/index.html",
						tempID: 'kejiao',
						cls: 'mui-icon iconfont icon-kejiaowenhua',
						permission: 'schapp_Behavior',
						childList: []
					}, {
						name: "page4",
						href: "../../html/page4/index.html",
						tempID: 'kejiao1',
						cls: 'mui-icon iconfont icon-kejiaowenhua',
						permission: 'schapp_Comment',
						childList: []
					}, {
						name: "page5",
						href: "../../html/page5/index.html",
						tempID: 'kejiao2',
						cls: 'mui-icon iconfont icon-kejiaowenhua',
						permission: 'schapp_Resource',
						childList: []
					}, {
						name: "page6",
						href: "../../html/page6/index.html",
						tempID: 'kejiao3',
						cls: 'mui-icon iconfont icon-kejiaowenhua',
						permission: 'schapp_Evaluation',
						childList: []
					}
					// , {
					// 	name: "page7",
					// 	href: "../../html/schapp_examination/index.html",
					// 	tempID: 'kaowu',
					// 	cls: 'mui-icon iconfont icon-kejiaowenhua',
					// 	permission: 'schapp_Examination',
					// 	childList: []
					// },
					]
				}
			});

			//创建子页面，首个选项卡页面显示，其它均隐藏；
			mui.plusReady(function() {
				var tempMenu = store.get(window.storageKeyName.MENULIST);
				console.log('tempMenu:' + JSON.stringify(tempMenu));
				var tempA = [];
				for (var i = 0; i < tempMenu.list[0].childList.length; i++) {
					var tempM1 = tempMenu.list[0].childList[i];
					for (var a = 0; a < indexPage.pageArray.length; a++) {
						var tempM0 = indexPage.pageArray[a];
						if (tempM0.permission == tempM1.url) {
							tempM0.name = tempM1.name;
							tempM0.access=tempM1.access;
							tempM0.childList = tempM1.childList;
							tempA.push(tempM0);
						} 
					}
				}
				if (tempA.length > 5) {
					var tempArrayM = tempA.slice(4);
					store.set(window.storageKeyName.MOREMENU, tempArrayM);
					tempA = tempA.slice(0, 4);
					tempA.push({
						name: "更多",
						href: "../../html/more/index.html",
						tempID: 'kejiao4',
						cls: 'mui-icon iconfont icon-kejiaowenhua',
						permission: 'more',
					});
				}
				indexPage.showArray = [].concat(tempA);

				//安卓的连续点击两次退出程序
				var backButtonPress = 0;
				//重写返回键
				mui.back = function(event) {
					backButtonPress++;
					if (backButtonPress > 1) {
						plus.runtime.quit();
					} else {
						plus.nativeUI.toast('再按一次退出应用');
					}
					setTimeout(function() {
						backButtonPress = 0;
					}, 1000);
					return false;
				};
				if (indexPage.showArray.length == 0) {
					mui.toast('暂无可用菜单');
					setTimeout(function() {
						store.remove(window.storageKeyName.PERSONALINFO);
						plus.webview.open('../../html/login/loginIndex.html');
						var curr = plus.webview.currentWebview();
						var wvs = plus.webview.all();
						for (var i = 0, len = wvs.length; i < len; i++) {
							//关闭除login页面外的其他页面
							if (wvs[i].getURL().indexOf('loginIndex.html') != -1) {
								continue;
							}
							plus.webview.close(wvs[i]);
						}
						curr.close();
					}, 1000);
				}
				var defaultUrl = indexPage.showArray[0].href;
				var self = plus.webview.currentWebview();
				var tempM = indexPage.showArray[0];
				var sub = plus.webview.create(defaultUrl, defaultUrl, subpage_style, {
					preload: tempM
				});
				self.append(sub);
				//当前激活选项
				activeTab = defaultUrl;
				var title = document.getElementById("title");
				console.log('11111111');
				//选项卡点击事件
				mui('.mui-bar-tab').on('tap', 'a', function(e) {
					var targetTab = this.getAttribute('href');
					console.log('11111111222:' + targetTab);
					if (targetTab == activeTab) {
						return;
					} else {
						var viewIsExists = plus.webview.getWebviewById(targetTab);
						if (viewIsExists == null || viewIsExists == '' || viewIsExists == undefined) {
							for (var i = 0; i < indexPage.showArray.length; i++) {
								var tempM = indexPage.showArray[i];
								if (targetTab == tempM.href) {
									var pageIndex = plus.webview.getWebviewById(targetTab);
									var newSub = plus.webview.create(targetTab, targetTab, subpage_style, {
										preload: tempM
									});
									newSub.hide();
									self.append(newSub);
								}
							}

						}
					}
					//更换标题
					//title.innerHTML = this.querySelector('.mui-tab-label').innerHTML;
					plus.webview.show(targetTab, "fade-in", 00);
					//隐藏当前;
					plus.webview.hide(activeTab);
					//更改当前活跃的选项卡 
					activeTab = targetTab;
				});
				setTimeout(function() {
					var defaultTab = document.getElementById(indexPage.showArray[0].tempID);
					console.log('11111111defaultTab:' + defaultTab);
					//模拟首页点击
					mui.trigger(defaultTab, 'tap');
					//切换选项卡高亮
					var current = document.querySelector(".mui-bar-tab>.mui-tab-item.mui-active");
					if (defaultTab !== current) {
						current.classList.remove('mui-active');
						defaultTab.classList.add('mui-active');
					}
				}, 1000);

			});
		</script>
	</body>

</html>
